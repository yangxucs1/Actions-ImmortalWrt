#
# Description: Build OpenWrt using GitHub Actions
#
# Copyright (c) 2019-2024 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#

name: ç¼–è¯‘X86_64-immortalwrtå›ºä»¶

permissions: write-all
#å¼€å¯å†™æƒé™ï¼Œé˜²æ­¢æ— æ³•ä¸Šä¼ åˆ°release

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      enable_ssh:    # å‚æ•°åç§°ï¼Œç”¨äºåœ¨å·¥ä½œæµä¸­å¼•ç”¨
        description: "Enable SSH debugging (true/false)"    # æè¿°ä¿¡æ¯ï¼Œæ˜¾ç¤ºåœ¨æ‰‹åŠ¨è§¦å‘ç•Œé¢
        required: true    # æ˜¯/å¦ä¸ºå¿…å¡«é¡¹ï¼ˆtrue/falseï¼‰
        default: "false"    # é»˜è®¤ä¸å¼€å¯SSHï¼Œå¦‚éœ€å¼€å¯SSHè¿æ¥ï¼Œåœ¨Run Workflowæ—¶æŠŠSSH connection to Actionsçš„å€¼æ”¹ä¸ºtrue
        type: choice    # è¾“å…¥ç±»å‹ä¸ºä¸‹æ‹‰é€‰æ‹©æ¡†
        options:    # ä¸‹æ‹‰æ¡†é€‰åˆ™å†…å®¹
          - "true"    # å¼€å¯SSHè°ƒè¯•
          - "false"   # å…³é—­SSHè°ƒè¯•

  #schedule:
      #å®šæ—¶ä»»åŠ¡
  #  - cron: 0 20 * * 4   #å¦‚éœ€å¼€å¯å®šæ—¶ä»»åŠ¡ï¼ŒæŠŠ-cronå‰çš„"#"å·åˆ é™¤
     #      åˆ†,æ—¶,æ—¥,æœˆ,å‘¨ã€‚æ¯å‘¨äº” 20æ—¶æ‰§è¡Œä¸€æ¬¡ (UTCæ—¶é—´)

env:    #å®šä¹‰ç¯å¢ƒå˜é‡ï¼Œä¿®æ”¹æ—¶éœ€è¦æ³¨æ„:(å†’å·)åé¢æœ‰ç©ºæ ¼
  FREE_DISK_SH: scripts/free_disk_space.sh    #æ¸…ç†ç©ºé—´è„šæœ¬
  ENV_SH: scripts/init_build_environment.sh    #å®‰è£…ç¼–è¯‘ä¾èµ–å·¥å…·è„šæœ¬
  SETTINGS_SH: scripts/init-settings.sh   #è‡ªå®šä¹‰è®¾ç½®è„šæœ¬ï¼Œå¦‚ï¼šæ›´æ”¹æºç ä¸­è·¯ç”±å™¨ç®¡ç† IP åœ°å€
  PACKAGES_SH: scripts/packages.sh    #æ·»åŠ è‡ªå®šä¹‰è½¯ä»¶ä»“åº“è„šæœ¬
  CLASH_CORE_SH: scripts/preset-clash-core-amd64.sh
  REPO_URL: https://github.com/immortalwrt/immortalwrt    #æºç ä»“åº“åœ°å€ï¼Œé€šè¿‡å˜æ›´ä»“åº“åœ°å€è¾¾åˆ°ç¼–è¯‘ä¸åŒçš„å›ºä»¶
  REPO_BRANCH: master
  # ä¿®æ”¹ REPO_BRANCH æ¥è¾¾åˆ°æ›´æ”¹åˆ†æ”¯ç‰ˆæœ¬,å¦‚ï¼šopenwrt-24.10
  CONFIG_FILE: 
  #é€‰æ‹©å¯¹åº”é…ç½®æ–‡ä»¶
  UPLOAD_BIN_DIR: false   #æ˜¯å¦ä¸Šä¼ binç›®å½•
  UPLOAD_FIRMWARE: true   # æ˜¯å¦ä¸Šä¼ æœ€ç»ˆå›ºä»¶
  UPLOAD_RELEASE: false   #æ˜¯å¦å°†å›ºä»¶å‘å¸ƒä¸ºRelease
  UPLOAD_DL_DIR: false    #æ˜¯å¦ä¸Šä¼ dlç›®å½•
  UPLOAD_config_DIR: false    #æ˜¯å¦ä¸Šä¼ .configç›®å½•
  TZ: Asia/Shanghai   #è®¾ç½®æ—¶åŒº

jobs:
  build:
    runs-on: ubuntu-latest   
#æŒ‡å®šè¿è¡Œç¯å¢ƒï¼Œå¦‚ï¼šubuntu-22.04
    
    steps:
    - name: å‡†å¤‡
      uses: actions/checkout@main

    - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
      env:
        DEBIAN_FRONTEND: noninteractive   #ç¦ç”¨äº¤äº’å¼æç¤ºï¼Œè½¯ä»¶åŒ…å®‰è£…è¿‡ç¨‹ä½¿ç”¨é»˜è®¤é…ç½®
      run: |
        chmod +x $FREE_DISK_SH && $FREE_DISK_SH   #èµ‹äºˆè„šæœ¬å¯æ‰§è¡Œæƒé™å¹¶è¿è¡Œè¯¥è„šæœ¬
        sudo -E apt-get -qq update -y
        sudo -E apt-get -qq full-upgrade -y
        chmod +x $ENV_SH && $ENV_SH
        sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
        sudo docker image prune -a -f
        sudo docker container prune -f
        sudo timedatectl set-timezone "$TZ"
        sudo mkdir -p /workdir    #åˆ›å»ºå·¥ä½œç›®å½•
        sudo chown $USER:$GROUPS /workdir   #è®¾ç½®ç›®å½•æƒé™ä»é»˜è®¤çš„ root æ”¹ä¸ºå½“å‰ç”¨æˆ·

    - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ1
      if: (!cancelled())
      run: df -hT

    - name: å…‹éš†æºç 
      working-directory: /workdir
      run: |
        git clone $REPO_URL --depth 1 -b $REPO_BRANCH openwrt   #å…‹éš†æºç ä»“åº“
        ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt   #åˆ›å»ºè½¯é“¾æ¥

    - name: è®¾ç½® VERSION ç¯å¢ƒå˜é‡
      run: echo "VERSION=${REPO_BRANCH#*-}" >> $GITHUB_ENV

    - name: å¼€å¯ç¼“å­˜
      uses: klever1988/cachewrtbuild@main
      with:
        ccache: 'true'    # å¯ç”¨ ccache ç¼“å­˜
        mixkey: '${{ env.VERSION }}_X86-64'   #å®šä¹‰ç¼“å­˜æ ‡è¯†
        prefix: ${{ github.workspace }}/openwrt   #æŒ‡å®šæºç æ ¹ç›®å½•è·¯å¾„

    - name: æ·»åŠ è‡ªå®šä¹‰è½¯ä»¶ä»“åº“
      run: |
        cd openwrt
        chmod +x $GITHUB_WORKSPACE/$PACKAGES_SH && $GITHUB_WORKSPACE/$PACKAGES_SH        

    - name: æ›´æ–°è½¯ä»¶åŒ…
      run: |
        cd openwrt
        ./scripts/feeds update -a

    - name: å®‰è£…è½¯ä»¶åŒ…å‰åˆ é™¤å†²çªçš„æ’ä»¶
      run: |
        cd openwrt
        rm -rf feeds/smpackage/{base-files,dnsmasq,firewall*,fullconenat,libnftnl,nftables,ppp,opkg,ucl,upx,vsftpd*,miniupnpd-iptables,wireless-regdb}

    - name: å®‰è£…è½¯ä»¶åŒ…
      run: |
        cd openwrt
        ./scripts/feeds install -a

    - name: æ‰§è¡Œè‡ªå®šä¹‰è®¾ç½®ï¼ˆæ”¹IPåœ°å€ç­‰ï¼‰
      run: |
        cd openwrt
        chmod +x $GITHUB_WORKSPACE/$SETTINGS_SH && $GITHUB_WORKSPACE/$SETTINGS_SH
        chmod +x $GITHUB_WORKSPACE/$CLASH_CORE_SH && $GITHUB_WORKSPACE/$CLASH_CORE_SH

    - name: SSHè¿œç¨‹è¿æ¥æœåŠ¡å™¨åœ¨çº¿é…ç½®å›ºä»¶
      id: ssh
      uses: mxschmitt/action-tmate@v3
      with:
        limit-access-to-actor: false  # å…³é—­æƒé™é™åˆ¶ï¼ˆä¸æ¨èï¼‰
      if: ${{ github.event.inputs.enable_ssh == 'true' }}   #ä»…å½“åœ¨Run Workflowæ—¶æŠŠSSH connection to Actionsçš„å€¼æ”¹ä¸º"true"æ—¶æ‰å¼€å¯SSH
      #å½“å‡ºç°ç±»ä¼¼â€œssh Y26QeagDtsPXp2mT6me5cnMRd@nyc1.tmate.ioâ€å­—æ ·æ—¶ï¼Œå¤åˆ¶ SSH è¿æ¥å‘½ä»¤ç²˜è´´åˆ°ç»ˆç«¯å†…æ‰§è¡Œï¼Œæˆ–è€…å¤åˆ¶é“¾æ¥åœ¨æµè§ˆå™¨ä¸­æ‰“å¼€ä½¿ç”¨ç½‘é¡µç»ˆç«¯ã€‚
      #ç„¶åè¾“å…¥ï¼šcd openwrt && make menuconfig
      #å®ŒæˆåæŒ‰Ctrl+Dç»„åˆé”®æˆ–æ‰§è¡Œexitå‘½ä»¤é€€å‡ºï¼Œåç»­ç¼–è¯‘å·¥ä½œå°†è‡ªåŠ¨è¿›è¡Œã€‚

    - name: ä¸‹è½½ç¼–è¯‘ä¾èµ–dll
      id: download-dll
      run: |
        cd openwrt
        make defconfig
        make download -j8
        find dl -size -1024c -exec ls -l {} \;
        find dl -size -1024c -exec rm -f {} \;
        make download -j8

    - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ2
      if: (!cancelled())
      run: df -hT

    - name: å¼€å§‹ç¼–è¯‘å›ºä»¶
      id: compile
      run: |
        cd openwrt
        echo -e "$(nproc) thread compile"
        make -j$(nproc) || make -j1 || make -j1 V=s
        make json_overview_image_info
        make checksum
        echo "status=success" >> $GITHUB_OUTPUT
        grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/.*DEVICE_(.*)=y/\1/' > DEVICE_NAME
        [ -s DEVICE_NAME ] && echo "DEVICE_NAME=_$(cat DEVICE_NAME)" >> $GITHUB_ENV
        echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

    - name: æ£€æŸ¥ç©ºé—´ä½¿ç”¨æƒ…å†µ3
      if: (!cancelled())
      run: df -hT

    - name: ä¸Šä¼  bin ç›®å½•
      uses: actions/upload-artifact@main
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_BIN_DIR == 'true'
      with:
        name: OpenWrt_bin${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: openwrt/bin

    - name: ä¸Šä¼  dl ç›®å½•
      uses: actions/upload-artifact@main
      if: env.UPLOAD_DL_DIR == 'true'
      with:
        name: OpenWrt_dl${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: openwrt/dl
 
     - name: ä¸Šä¼  config 
      uses: actions/upload-artifact@main
      if: UPLOAD_config_DIR == 'true'
      with:
        name: OpenWrt_config${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: openwrt


    - name: æ•´ç†å›ºä»¶æ–‡ä»¶å¤¹
      id: organize
      if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
      run: |
        cd openwrt/bin/targets/*/*
        rm -rf packages
        echo "FIRMWARE=$PWD" >> $GITHUB_ENV
        echo "status=success" >> $GITHUB_OUTPUT

    - name: ä¸Šä¼ å›ºä»¶
      uses: actions/upload-artifact@main
      if: steps.organize.outputs.status == 'success' && !cancelled()
      with:
        name: OpenWrt_firmware${{ env.DEVICE_NAME }}${{ env.FILE_DATE }}
        path: ${{ env.FIRMWARE }}

    - name: ç”Ÿæˆreleaseæ ‡ç­¾
      id: tag
      if: env.UPLOAD_RELEASE == 'true' && !cancelled()
      run: |
        VERSION1="${REPO_BRANCH#*-}"
        echo -e "ğŸ‰ X86-64 å¹³å°\nâœ… ${VERSION1} æºç \nâ—ï¸ ipåœ°å€ : 192.168.123.1" >> release.txt
        echo "release_tag=$(date +"%Y.%m.%d-%H%M")" >> $GITHUB_OUTPUT
        echo "status=success" >> $GITHUB_OUTPUT

    - name: å‘å¸ƒrelease
      uses: softprops/action-gh-release@master
      if: steps.tag.outputs.status == 'success' && !cancelled()
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: ${{ env.FIRMWARE }}/*

    - name: åˆ é™¤ä»¥å‰å‘å¸ƒçš„å›ºä»¶
      uses: dev-drprasad/delete-older-releases@v0.3.3
      if: steps.compile.outputs.status == 'success' && env.UPLOAD_RELEASE == 'true' && !cancelled()
      with:
        keep_latest: 5
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: åˆ é™¤ä»¥å‰çš„å·¥ä½œæµç¨‹
      uses: Mattraks/delete-workflow-runs@main
      with:
        retain_days: 0
        keep_minimum_runs: 2
