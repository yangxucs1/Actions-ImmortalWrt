name: å•ç‹¬è¿è¡Œåˆå¹¶å‘å¸ƒæ‰€æœ‰å›ºä»¶

permissions: write-all

on:
  workflow_dispatch:
    # ä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘ï¼Œç¡®ä¿å¯ä»¥ç‹¬ç«‹è¿è¡Œ

env:
  TZ: Asia/Shanghai

jobs:
  release-all:
    name: åˆå¹¶å‘å¸ƒæ‰€æœ‰å›ºä»¶
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id

    steps:
      - name: å‡†å¤‡å·¥ä½œç›®å½•
        run: |
          # ç¡®ä¿ç›®æ ‡ç›®å½•å­˜åœ¨ï¼Œé¿å…åç»­å‘½ä»¤æŠ¥é”™
          mkdir -p all-firmwares
          mkdir -p version-info-all

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©ï¼ˆé€‚é…çŸ©é˜µä½œä¸šï¼‰
        uses: actions/download-artifact@v4
        with:
          path: all-firmwares
          # åªä¸‹è½½å›ºä»¶ç±»Artifactï¼ˆåŒ¹é…çŸ©é˜µç”Ÿæˆçš„å‘½åæ ¼å¼ï¼‰
          pattern: firmware-*
          merge-multiple: false  # ä¿ç•™æ¯ä¸ªArtifactçš„ç‹¬ç«‹ç›®å½•ç»“æ„

      - name: ä¸‹è½½ç‰ˆæœ¬ä¿¡æ¯ï¼ˆé€‚é…çŸ©é˜µä½œä¸šï¼‰
        uses: actions/download-artifact@v4
        with:
          path: version-info-all
          # åªä¸‹è½½ç‰ˆæœ¬ä¿¡æ¯ç±»Artifact
          pattern: version_info-*
          merge-multiple: false

      - name: æ£€æŸ¥æ˜¯å¦å­˜åœ¨æ„å»ºäº§ç‰©
        run: |
          # æœç´¢æ‰€æœ‰å­ç›®å½•ä¸­çš„å›ºä»¶æ–‡ä»¶ï¼ˆé€‚é…çŸ©é˜µç”Ÿæˆçš„å¤šå±‚ç»“æ„ï¼‰
          FIRMWARE_FILES=$(find all-firmwares -type f \( -name "*.bin" -o -name "*.img" \))
          if [ -z "$FIRMWARE_FILES" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°ä»»ä½•æ„å»ºäº§ç‰©ï¼Œè¯·å…ˆç¡®ä¿ build å·¥ä½œæµè‡³å°‘æœ‰ä¸€ä¸ªçŸ©é˜µç»„åˆæˆåŠŸè¿è¡Œå¹¶ç”Ÿæˆ Artifacts"
            exit 1
          else
            echo "æ‰¾åˆ°ä»¥ä¸‹å›ºä»¶æ–‡ä»¶ï¼š"
            echo "$FIRMWARE_FILES"
          fi

      - name: æ£€æŸ¥æ˜¯å¦å­˜åœ¨ç‰ˆæœ¬ä¿¡æ¯
        run: |
          VERSION_FILES=$(find version-info-all -type f -name "version_target_*.txt")
          if [ -z "$VERSION_FILES" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ï¼Œè¯·ç¡®ä¿ build å·¥ä½œæµæ­£å¸¸ç”Ÿæˆç‰ˆæœ¬ä¿¡æ¯"
            exit 1
          fi

      - name: æå–ç‰ˆæœ¬å’Œç›®æ ‡ä¿¡æ¯
        id: extract_version_target
        run: |
          echo "æ‰€æœ‰ç‰ˆæœ¬å’Œç›®æ ‡è®¾å¤‡ä¿¡æ¯æ±‡æ€»" > version-info-all.txt
          echo "==========================================" >> version-info-all.txt
          
          VERSIONS=()
          TARGETS=()
          
          # éå†æ‰€æœ‰ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ï¼ˆé€‚é…çŸ©é˜µç”Ÿæˆçš„è·¯å¾„ç»“æ„ï¼‰
          for file in $(find version-info-all -type f -name "version_target_*.txt"); do
            if [ -f "$file" ]; then
              cat "$file" >> version-info-all.txt
              echo "==========================================" >> version-info-all.txt
              while IFS= read -r line; do
                IFS=':' read -ra parts <<< "$line"
                VERSIONS+=("${parts[0]}")
                TARGETS+=("${parts[1]}")
              done < "$file"
            fi
          done
          
          UNIQUE_VERSIONS=($(printf "%s\n" "${VERSIONS[@]}" | sort -u))
          UNIQUE_TARGETS=($(printf "%s\n" "${TARGETS[@]}" | sort -u))
          echo "versions=${UNIQUE_VERSIONS[*]}" >> $GITHUB_OUTPUT
          echo "targets=${UNIQUE_TARGETS[*]}" >> $GITHUB_OUTPUT

      - name: æ•´ç†åˆå¹¶å›ºä»¶
        run: |
          mkdir -p final-release
          # å¤åˆ¶æ‰€æœ‰å›ºä»¶æ–‡ä»¶å’Œé…ç½®æ–‡ä»¶ï¼ˆæ’é™¤ä¸­é—´ç›®å½•ç»“æ„ï¼‰
          find all-firmwares -type f \( -name "*.bin" -o -name "*.img" -o -name "*.config" -o -name "*build-info.txt" \) -exec cp {} final-release/ \;
          
          # åˆå¹¶æ‰€æœ‰æ„å»ºä¿¡æ¯
          echo "# æ‰€æœ‰å›ºä»¶è¯¦ç»†ä¿¡æ¯" > final-release/all-build-info.txt
          echo "==========================================" >> final-release/all-build-info.txt
          for info_file in $(find final-release -type f -name "*build-info.txt" | grep -v "all-build-info.txt"); do
            if [ -f "$info_file" ]; then
              echo -e "\n$(cat "$info_file")" >> final-release/all-build-info.txt
              echo "==========================================" >> final-release/all-build-info.txt
              # åˆ é™¤å•ä¸ªæ„å»ºä¿¡æ¯æ–‡ä»¶
              rm -f "$info_file"
            fi
          done
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          echo "# OpenWRT å›ºä»¶æ±‡æ€»å‘å¸ƒ" > release.txt
          echo "å‘å¸ƒæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" >> release.txt
          echo "åŒ…å«ä»¥ä¸‹ç‰ˆæœ¬å’Œè®¾å¤‡çš„å›ºä»¶ï¼š" >> release.txt
          echo "- ç‰ˆæœ¬: ${{ steps.extract_version_target.outputs.versions }}" >> release.txt
          echo "- è®¾å¤‡: ${{ steps.extract_version_target.outputs.targets }}" >> release.txt
          echo -e "\nå„å›ºä»¶è¯¦ç»†ä¿¡æ¯åŠMD5è¯·æŸ¥çœ‹ all-build-info.txt æ–‡ä»¶" >> release.txt
          echo -e "\nğŸŒ é»˜è®¤ç®¡ç†IP: 192.168.123.1" >> release.txt

      - name: ç”Ÿæˆç»Ÿä¸€å‘å¸ƒæ ‡ç­¾
        id: tag
        run: |
          echo "release_tag=openwrt-all-firmwares_$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: å‘å¸ƒåˆå¹¶åçš„Release
        uses: softprops/action-gh-release@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: final-release/*

      - name: ä¿ç•™æœ€æ–°3ä¸ªRelease
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ é™¤æ—§çš„å·¥ä½œæµç¨‹
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 3
