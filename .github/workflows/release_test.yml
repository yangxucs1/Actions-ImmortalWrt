release-all:
  name: åˆå¹¶å‘å¸ƒæ‰€æœ‰å›ºä»¶
  runs-on: ubuntu-latest
  needs: build
  if: |
    ${{ 
      always() && 
      !cancelled() && 
      contains(join(needs.build.*.result, ','), 'success')  && 
      needs.build.outputs.upload_release == 'true' 
    }}

  steps:
    - name: å‡†å¤‡ç›®å½•ï¼ˆç¡®ä¿ç›®å½•å­˜åœ¨ï¼‰
      run: |
        mkdir -p all-firmwares  # æå‰åˆ›å»ºç›®å½•ï¼Œé¿å…findæŠ¥é”™
        mkdir -p version-info-all

    - name: ä¸‹è½½æ‰€æœ‰å›ºä»¶äº§ç‰©ï¼ˆç²¾å‡†åŒ¹é…ï¼‰
      uses: actions/download-artifact@v4
      with:
        path: all-firmwares
        pattern: firmware-*  # åªä¸‹è½½å›ºä»¶ç±»Artifactï¼ˆåŒ¹é…buildä¸Šä¼ çš„åç§°æ ¼å¼ï¼‰
        merge-multiple: false  # ä¿ç•™æ¯ä¸ªArtifactçš„ç‹¬ç«‹ç›®å½•

    - name: ä¸‹è½½ç‰ˆæœ¬ä¿¡æ¯
      uses: actions/download-artifact@v4
      with:
        path: version-info-all
        pattern: version_info_*  # ç²¾å‡†åŒ¹é…ç‰ˆæœ¬ä¿¡æ¯Artifact
        merge-multiple: false

    - name: æ£€æŸ¥æ˜¯å¦å­˜åœ¨æœ‰æ•ˆå›ºä»¶æ–‡ä»¶
      run: |
        # æœç´¢æ‰€æœ‰å­ç›®å½•ä¸­çš„.bin/.imgæ–‡ä»¶ï¼ˆé€‚é…åµŒå¥—ç›®å½•ç»“æ„ï¼‰
        FIRMWARE_FILES=$(find all-firmwares -type f \( -name "*.bin" -o -name "*.img" \))
        if [ -z "$FIRMWARE_FILES" ]; then
          echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°ä»»ä½•å›ºä»¶æ–‡ä»¶ï¼ˆ.bin/.imgï¼‰ï¼Œè¯·æ£€æŸ¥buildä½œä¸šæ˜¯å¦æ­£ç¡®ç”Ÿæˆäº§ç‰©"
          # æ‰“å°ç›®å½•ç»“æ„è¾…åŠ©è°ƒè¯•
          echo "å½“å‰all-firmwaresç›®å½•ç»“æ„ï¼š"
          tree all-firmwares
          exit 1
        else
          echo "æ‰¾åˆ°ä»¥ä¸‹å›ºä»¶æ–‡ä»¶ï¼š"
          echo "$FIRMWARE_FILES"
        fi

    - name: æå–ç‰ˆæœ¬å’Œç›®æ ‡ä¿¡æ¯
      id: extract_version_target
      run: |
        echo "æ‰€æœ‰ç‰ˆæœ¬å’Œç›®æ ‡è®¾å¤‡ä¿¡æ¯æ±‡æ€»" > version-info-all.txt
        echo "==========================================" >> version-info-all.txt
        
        VERSIONS=()
        TARGETS=()
        
        # éå†ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ï¼ˆé€‚é…åµŒå¥—ç›®å½•ï¼‰
        for file in $(find version-info-all -type f -name "version_target_*.txt"); do
          if [ -f "$file" ]; then
            cat "$file" >> version-info-all.txt
            echo "==========================================" >> version-info-all.txt
            while IFS= read -r line; do
              IFS=':' read -ra parts <<< "$line"
              VERSIONS+=("${parts[0]}")
              TARGETS+=("${parts[1]}")
            done < "$file"
          fi
        done
        
        UNIQUE_VERSIONS=($(printf "%s\n" "${VERSIONS[@]}" | sort -u))
        UNIQUE_TARGETS=($(printf "%s\n" "${TARGETS[@]}" | sort -u))
        echo "versions=${UNIQUE_VERSIONS[*]}" >> $GITHUB_OUTPUT
        echo "targets=${UNIQUE_TARGETS[*]}" >> $GITHUB_OUTPUT

    - name: æ•´ç†åˆå¹¶å›ºä»¶
      run: |
        mkdir -p final-release
        # å¤åˆ¶æ‰€æœ‰å›ºä»¶æ–‡ä»¶ã€é…ç½®æ–‡ä»¶å’Œä¿¡æ¯æ–‡ä»¶ï¼ˆæ’é™¤åµŒå¥—ç›®å½•ç»“æ„ï¼‰
        find all-firmwares -type f \( -name "*.bin" -o -name "*.img" -o -name "*.config" -o -name "*build-info.txt" \) -exec cp {} final-release/ \;
        
        # åˆå¹¶æ‰€æœ‰æ„å»ºä¿¡æ¯
        echo "# æ‰€æœ‰å›ºä»¶è¯¦ç»†ä¿¡æ¯" > final-release/all-build-info.txt
        echo "==========================================" >> final-release/all-build-info.txt
        for info_file in $(find final-release -type f -name "*build-info.txt" | grep -v "all-build-info.txt"); do
          if [ -f "$info_file" ]; then
            echo -e "\n$(cat "$info_file")" >> final-release/all-build-info.txt
            echo "==========================================" >> final-release/all-build-info.txt
            rm -f "$info_file"  # åˆ é™¤å•ä¸ªä¿¡æ¯æ–‡ä»¶
          fi
        done
        
        # ç”Ÿæˆå‘å¸ƒè¯´æ˜
        echo "# OpenWRT å›ºä»¶æ±‡æ€»å‘å¸ƒ" > release.txt
        echo "å‘å¸ƒæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" >> release.txt
        echo "åŒ…å«ä»¥ä¸‹ç‰ˆæœ¬å’Œè®¾å¤‡çš„å›ºä»¶ï¼š" >> release.txt
        echo "- ç‰ˆæœ¬: ${{ steps.extract_version_target.outputs.versions }}" >> release.txt
        echo "- è®¾å¤‡: ${{ steps.extract_version_target.outputs.targets }}" >> release.txt
        echo -e "\nå„å›ºä»¶è¯¦ç»†ä¿¡æ¯åŠMD5è¯·æŸ¥çœ‹ all-build-info.txt æ–‡ä»¶" >> release.txt
        echo -e "\nğŸŒ é»˜è®¤ç®¡ç†IP: 192.168.123.1" >> release.txt

    - name: ç”Ÿæˆç»Ÿä¸€å‘å¸ƒæ ‡ç­¾
      id: tag
      run: |
        echo "release_tag=openwrt-all-firmwares_$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

    - name: å‘å¸ƒåˆå¹¶åçš„Release
      uses: softprops/action-gh-release@master
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.tag.outputs.release_tag }}
        body_path: release.txt
        files: final-release/*

    - name: ä¿ç•™æœ€æ–°3ä¸ªRelease
      uses: dev-drprasad/delete-older-releases@v0.3.3
      with:
        keep_latest: 3
        delete_tags: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: åˆ é™¤æ—§çš„å·¥ä½œæµç¨‹
      uses: Mattraks/delete-workflow-runs@main
      with:
        retain_days: 0
        keep_minimum_runs: 3
