name: ç‹¬ç«‹å‘å¸ƒæ„å»ºäº§ç‰©

permissions:
  contents: write

on:
  workflow_dispatch:
    inputs:
      source_workflow_run_id:
        description: "æºæ„å»ºå·¥ä½œæµè¿è¡ŒIDï¼ˆå¯é€‰ï¼Œç•™ç©ºè‡ªåŠ¨æŸ¥æ‰¾æœ€è¿‘æˆåŠŸè¿è¡Œï¼‰"
        required: false
        default: ""

env:
  TZ: Asia/Shanghai

jobs:
  standalone-release:
    name: å‘å¸ƒå·²æœ‰æ„å»ºäº§ç‰©
    runs-on: ubuntu-latest
    
    steps:
      - name: è·å–æºæ„å»ºå·¥ä½œæµè¿è¡ŒID
        id: get-source-run
        run: |
          if [ -n "${{ github.event.inputs.source_workflow_run_id }}" ]; then
            echo "ä½¿ç”¨æŒ‡å®šçš„å·¥ä½œæµè¿è¡ŒID: ${{ github.event.inputs.source_workflow_run_id }}"
            echo "source_run_id=${{ github.event.inputs.source_workflow_run_id }}" >> $GITHUB_OUTPUT
          else
            echo "è‡ªåŠ¨æŸ¥æ‰¾æœ€è¿‘æˆåŠŸçš„å¤šç‰ˆæœ¬ OpenWRT æ„å»ºtestå·¥ä½œæµè¿è¡Œ..."
            
            # ä½¿ç”¨GitHub APIæŸ¥æ‰¾æœ€è¿‘æˆåŠŸçš„æ„å»ºè¿è¡Œ
            response=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/actions/runs?event=workflow_dispatch&status=completed&per_page=20")
            
            # æŸ¥æ‰¾åä¸º"å¤šç‰ˆæœ¬ OpenWRT æ„å»ºtest"çš„æˆåŠŸè¿è¡Œ
            run_id=$(echo "$response" | jq -r '.workflow_runs[] | select(.name == "å¤šç‰ˆæœ¬ OpenWRT æ„å»ºtest" and .conclusion == "success") | .id' | head -1)
            
            if [ -n "$run_id" ] && [ "$run_id" != "null" ]; then
              echo "æ‰¾åˆ°æœ€è¿‘çš„æˆåŠŸè¿è¡ŒID: $run_id"
              echo "source_run_id=$run_id" >> $GITHUB_OUTPUT
            else
              echo "é”™è¯¯ï¼šæ²¡æœ‰æ‰¾åˆ°æˆåŠŸçš„å¤šç‰ˆæœ¬ OpenWRT æ„å»ºtestå·¥ä½œæµè¿è¡Œ"
              exit 1
            fi
          fi

      - name: ä¸‹è½½æ‰€æœ‰æ„å»ºäº§ç‰©
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ steps.get-source-run.outputs.source_run_id }}
          path: all-firmwares

      - name: ä¸‹è½½ç‰ˆæœ¬ä¿¡æ¯
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ steps.get-source-run.outputs.source_run_id }}
          path: version-info-all
          pattern: version_info*

      - name: æå–ç‰ˆæœ¬å’Œç›®æ ‡ä¿¡æ¯
        id: extract_version_target
        run: |
          # åˆ›å»ºåˆå¹¶åçš„ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          echo "æ‰€æœ‰ç‰ˆæœ¬å’Œç›®æ ‡è®¾å¤‡ä¿¡æ¯æ±‡æ€»" > version-info-all.txt
          echo "==========================================" >> version-info-all.txt
          
          VERSIONS=()
          TARGETS=()
          
          # éå†æ‰€æœ‰ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶å¹¶åˆå¹¶å†…å®¹
          for file in $(find version-info-all -type f -name "version_target_*.txt"); do
            if [ -f "$file" ]; then
              # å°†å•ä¸ªæ–‡ä»¶å†…å®¹è¿½åŠ åˆ°åˆå¹¶æ–‡ä»¶
              cat "$file" >> version-info-all.txt
              echo "==========================================" >> version-info-all.txt
              # æå–ç‰ˆæœ¬å’Œç›®æ ‡è®¾å¤‡ä¿¡æ¯ç”¨äºåç»­å¤„ç†
              while IFS= read -r line; do
                IFS=':' read -ra parts <<< "$line"
                VERSIONS+=("${parts[0]}")
                TARGETS+=("${parts[1]}")
              done < "$file"
            fi
          done
          # å»é‡å¤„ç†
          UNIQUE_VERSIONS=($(printf "%s\n" "${VERSIONS[@]}" | sort -u))
          UNIQUE_TARGETS=($(printf "%s\n" "${TARGETS[@]}" | sort -u))
          # è¾“å‡ºåˆ°æ­¥éª¤å˜é‡
          echo "versions=${UNIQUE_VERSIONS[*]}" >> $GITHUB_OUTPUT
          echo "targets=${UNIQUE_TARGETS[*]}" >> $GITHUB_OUTPUT

      - name: æ•´ç†åˆå¹¶å›ºä»¶
        run: |
          mkdir -p final-release
          # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶åˆ°ç»Ÿä¸€ç›®å½•
          find all-firmwares -type f -exec cp {} final-release/ \;
          # åˆå¹¶æ‰€æœ‰ä¿¡æ¯æ–‡ä»¶ä¸ºç»Ÿä¸€çš„ all-build-info.txt
          echo "# æ‰€æœ‰å›ºä»¶è¯¦ç»†ä¿¡æ¯" > final-release/all-build-info.txt
          echo "==========================================" >> final-release/all-build-info.txt
          # éå†æ‰€æœ‰ä¿¡æ¯æ–‡ä»¶å¹¶è¿½åŠ å†…å®¹
          for info_file in $(find all-firmwares -type f -name "*build-info.txt" | grep -v "all-build-info.txt"); do
            if [ -f "$info_file" ]; then
              echo -e "\n$(cat "$info_file")" >> final-release/all-build-info.txt
              echo "==========================================" >> final-release/all-build-info.txt
            fi
          done
          # åˆ é™¤é™¤all-build-info.txtå¤–çš„å…¶ä»–build-info.txtæ–‡ä»¶
          find final-release -type f -name "*build-info.txt" -not -name "all-build-info.txt" -delete
          
          #ç”Ÿæˆreleaseæ ‡é¢˜
          echo "# OpenWRT å›ºä»¶æ±‡æ€»å‘å¸ƒ" > release.txt
          echo "å‘å¸ƒæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" >> release.txt
          echo "åŸºäºå·¥ä½œæµè¿è¡Œ: #${{ steps.get-source-run.outputs.source_run_id }}" >> release.txt
          echo "åŒ…å«ä»¥ä¸‹ç‰ˆæœ¬å’Œè®¾å¤‡çš„å›ºä»¶ï¼š" >> release.txt
          echo "- ç‰ˆæœ¬: ${{ steps.extract_version_target.outputs.versions }}" >> release.txt
          echo "- è®¾å¤‡: ${{ steps.extract_version_target.outputs.targets }}" >> release.txt
          echo -e "\nå„å›ºä»¶è¯¦ç»†ä¿¡æ¯åŠMD5è¯·æŸ¥çœ‹ all-build-info.txt æ–‡ä»¶" >> release.txt
          echo -e "\nğŸŒ é»˜è®¤ç®¡ç†IP: 192.168.123.1" >> release.txt

      - name: ç”Ÿæˆç»Ÿä¸€å‘å¸ƒæ ‡ç­¾
        id: tag
        run: |
          echo "release_tag=openwrt-all-firmwares_$(date +'%Y%m%d%H%M')" >> $GITHUB_OUTPUT

      - name: å‘å¸ƒåˆå¹¶åçš„Release
        uses: softprops/action-gh-release@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: final-release/*

      - name: ä¿ç•™æœ€æ–°3ä¸ªRelease
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: æ˜¾ç¤ºå‘å¸ƒç»“æœ
        run: |
          echo "âœ… å‘å¸ƒæˆåŠŸå®Œæˆï¼"
          echo "ğŸ·ï¸  å‘å¸ƒæ ‡ç­¾: ${{ steps.tag.outputs.release_tag }}"
          echo "ğŸ“¦ å‘å¸ƒæ–‡ä»¶æ•°é‡: $(find final-release -type f | wc -l)"
          echo "ğŸ”— æºå·¥ä½œæµè¿è¡Œ: #${{ steps.get-source-run.outputs.source_run_id }}"
