#
# Description: Build OpenWRT using GitHub Actions
#
# Copyright (c) 2019-2024 P3TERX <https://p3terx.com>
#
# This is free software, licensed under the MIT License.
# See /LICENSE for more information.
#

name: å¤šç‰ˆæœ¬ OpenWRT æ„å»ºtest

permissions: write-all
  # å¼€å¯å†™æƒé™ï¼Œé˜²æ­¢æ— æ³•ä¸Šä¼ åˆ°release

on:
  repository_dispatch:
  workflow_dispatch:
    inputs:
      enable_ssh:           
        description: "å¯ç”¨SSHè°ƒè¯• (true/false)"
        required: true
        default: "false"
        type: choice
        options:
          - "true"
          - "false"
      action:
        description: "æ“ä½œç±»å‹ (build: æ­£å¸¸æ„å»º, build-nocache: æ¸…ç†ç¼“å­˜æ„å»º)"
        required: true
        default: "build"
        type: choice
        options:
          - build
          - build-nocache

env:
  ENV_SH: scripts/environment.sh
  PACKAGES_SH: scripts/packages.sh
  SETTINGS_SH: scripts/init-settings.sh
  CLASH_CORE_SH: scripts/preset-clash-core-amd64.sh
  UPLOAD_BIN_DIR: true
  UPLOAD_FIRMWARE: true
  UPLOAD_RELEASE: true
  TZ: Asia/Shanghai

jobs:
  build:
    name: æ„å»º ${{ matrix.version }} - ${{ matrix.target }}
    runs-on: ubuntu-latest
    if: github.event.repository.owner.id == github.event.sender.id
    strategy:
      fail-fast: false
      matrix:
        version: [ "Lean", "Lienol", "immortalwrt" ]
        target: [ "X86-64", "Newifi3-D2" ]
        include:
          - version: Lean
            repo_url: https://github.com/coolsnowwolf/lede.git
            branch: master
          - version: Lienol
            repo_url: https://github.com/Lienol/openwrt.git
            branch: main
          - version: immortalwrt
            repo_url: https://github.com/immortalwrt/immortalwrt.git
            branch: master

    steps:
      - name: å‡†å¤‡
        uses: actions/checkout@main

      - name: æ£€æŸ¥é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        id: check_config
        run: |
          CONFIG_DIR="configs/${{ matrix.version }}"
          TARGET_NAME="${{ matrix.target }}"
          MATCHED_FILE=$(find "$CONFIG_DIR" -maxdepth 1 -type f -iname "${TARGET_NAME}.config" | head -n 1)
          
          if [ -f "$MATCHED_FILE" ]; then
            echo "æ‰¾åˆ°åŒ¹é…çš„é…ç½®æ–‡ä»¶: $MATCHED_FILE"
            echo "CONFIG_FILE=$MATCHED_FILE" >> $GITHUB_ENV
            echo "config_exists=true" >> $GITHUB_OUTPUT
          else
            echo "åœ¨ $CONFIG_DIR ä¸­æœªæ‰¾åˆ°ä¸ ${TARGET_NAME}.config åŒ¹é…çš„æ–‡ä»¶ï¼Œç»ˆæ­¢æµç¨‹!"
            echo "config_exists=false" >> $GITHUB_OUTPUT
          fi
          
      - name: ç»ˆæ­¢ä¸å­˜åœ¨é…ç½®æ–‡ä»¶çš„æµç¨‹
        if: steps.check_config.outputs.config_exists == 'false'
        run: |
          echo "é…ç½®æ–‡ä»¶ä¸å­˜åœ¨ï¼Œç»ˆæ­¢å·¥ä½œæµ"
          exit 1

      - name: æ¸…ç†ç£ç›˜ç©ºé—´(Ubuntu)
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: åˆå§‹åŒ–ç¼–è¯‘ç¯å¢ƒ
        env:
          DEBIAN_FRONTEND: noninteractive
        run: |
          sudo -E apt-get -qq update -y
          sudo -E apt-get -qq full-upgrade -y
          chmod +x $ENV_SH && $ENV_SH
          sudo rm -rf /etc/apt/sources.list.d/* /usr/share/dotnet /usr/local/lib/android /opt/ghc /opt/hostedtoolcache/CodeQL
          sudo docker image prune -a -f
          sudo docker container prune -f
          sudo -E apt-get -qq autoremove --purge
          sudo -E apt-get -qq clean
          sudo timedatectl set-timezone "$TZ"
          sudo mkdir -p /workdir
          sudo chown $USER:$GROUPS /workdir

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        if: (!cancelled())
        run: df -hT

      - name: å…‹éš†æºä»£ç 
        working-directory: /workdir
        if: steps.check_config.outputs.config_exists == 'true'
        run: |
          echo "ä» ${{ matrix.version }} å…‹éš† ${{ matrix.branch }} åˆ†æ”¯..."
          git clone --depth=1 -b ${{ matrix.branch }} ${{ matrix.repo_url }} openwrt
          ln -sf /workdir/openwrt $GITHUB_WORKSPACE/openwrt

      - name: è®¾ç½®ç‰ˆæœ¬ç¯å¢ƒå˜é‡
        run: |
          if [ "${{ matrix.version }}" = "Lean" ]; then
            echo "VERSION=lede-master" >> $GITHUB_ENV
          elif [ "${{ matrix.version }}" = "Lienol" ]; then
            echo "VERSION=lienol-24.10" >> $GITHUB_ENV
          elif [ "${{ matrix.version }}" = "immortalwrt" ]; then
            echo "VERSION=immortalwrt-master" >> $GITHUB_ENV
          fi

      - name: æ·»åŠ è‡ªå®šä¹‰è½¯ä»¶ä»“åº“
        run: |
          cd openwrt
          chmod +x $GITHUB_WORKSPACE/$PACKAGES_SH && $GITHUB_WORKSPACE/$PACKAGES_SH        

      - name: æ›´æ–° feeds
        run: |
          cd openwrt
          ./scripts/feeds update -a

      - name: å®‰è£…è½¯ä»¶åŒ…å‰åˆ é™¤å¯èƒ½å†²çªçš„æ’ä»¶
        run: |
          cd openwrt
          rm -rf feeds/smpackage/{base-files,dnsmasq,firewall*,fullconenat,libnftnl,nftables,ppp,opkg,ucl,upx,vsftpd*,miniupnpd-iptables,wireless-regdb}

      - name: å®‰è£… feeds è½¯ä»¶åŒ…
        run: |
          cd openwrt
          ./scripts/feeds install -a

      - name: æ‰§è¡Œè‡ªå®šä¹‰è®¾ç½®
        run: |
          [ -d files ] && mv files openwrt/files || echo "files ç›®å½•ä¸å­˜åœ¨"
          [ -f ${{ env.CONFIG_FILE }} ] && cat ${{ env.CONFIG_FILE }} >> openwrt/.config

          cd openwrt
          chmod +x $GITHUB_WORKSPACE/$SETTINGS_SH && $GITHUB_WORKSPACE/$SETTINGS_SH
          chmod +x $GITHUB_WORKSPACE/$CLASH_CORE_SH && $GITHUB_WORKSPACE/$CLASH_CORE_SH

      - name: SSHè¿œç¨‹è¿æ¥æœåŠ¡å™¨åœ¨çº¿é…ç½®å›ºä»¶
        id: ssh
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: false
        if: ${{ github.event.inputs.enable_ssh == 'true' }}

      - name: ä¸‹è½½ç¼–è¯‘ä¾èµ–è½¯ä»¶åŒ…
        id: download-dl
        run: |
          cd openwrt
          make defconfig
          make download -j$(($(nproc)+1))
          find dl -size -1024c -exec ls -l {} \;
          find dl -size -1024c -exec rm -f {} \;
          make download -j$(($(nproc)+1))

      - name: å¼€å¯ç¼“å­˜
        uses: stupidloud/cachewrtbuild@main
        with:
          ccache: 'true'
          mixkey: ${{ matrix.version }}-${{ matrix.target }}
          clean: ${{ contains(github.event.action, 'nocache') }}
          prefix: ${{ github.workspace }}/openwrt

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        if: (!cancelled())
        run: df -hT

      - name: å¼€å§‹ç¼–è¯‘å›ºä»¶
        id: compile
        run: |
          cd openwrt
          echo -e "$(($(nproc)+1)) çº¿ç¨‹ç¼–è¯‘"
          if make -j$(($(nproc) + 1)) ; then
            echo "ç¼–è¯‘æˆåŠŸ"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "ç¼–è¯‘å¤±è´¥ï¼Œå°è¯•å•çº¿ç¨‹ç¼–è¯‘..."
            if make -j1 V=s ; then
              echo "å•çº¿ç¨‹ç¼–è¯‘æˆåŠŸ"
              echo "status=success" >> $GITHUB_OUTPUT
            else
              echo "ç¼–è¯‘å¤±è´¥"
              echo "status=failed" >> $GITHUB_OUTPUT
            fi 
          fi

          grep '^CONFIG_TARGET.*DEVICE.*=y' .config | sed -r 's/^CONFIG_TARGET_(.*)_DEVICE_(.*)=y/\1-\2/'  > DEVICE_NAME
          [ -s DEVICE_NAME ] && echo "DEVICE_NAME=$(cat DEVICE_NAME)" >> $GITHUB_ENV
          echo "FILE_DATE=_$(date +"%Y%m%d%H%M")" >> $GITHUB_ENV

      - name: æ£€æŸ¥ç£ç›˜ç©ºé—´
        if: (!cancelled())
        run: df -hT

      - name: æ•´ç†å›ºä»¶æ–‡ä»¶å¤¹
        working-directory: /workdir
        id: organize
        if: env.UPLOAD_FIRMWARE == 'true' && !cancelled()
        run: |
          mkdir -p firmware
          cd openwrt/bin/targets/*/*/
          TARGET_PLATFORM=$(basename $(dirname $(pwd)))
          echo "å½“å‰ç›®æ ‡å¹³å°: $TARGET_PLATFORM"     

          shopt -s nullglob    
          shopt -s nocasematch 
          
          if [[ "$TARGET_PLATFORM" == x86* ]]; then
            for file in *combined* *sysupgrade*; do
            [ -f "$file" ] && mv "$file" "/workdir/firmware/${{ matrix.version }}_$file"
            done
          else
            for file in *squashfs*.bin; do
            [ -f "$file" ] && mv "$file" "/workdir/firmware/${{ matrix.version }}_$file"
            done
          fi
          
          cd /workdir/firmware
          INFO_FILE="${{ matrix.version }}_${{matrix.target}}_build-info.txt"
          printf "ç‰ˆæœ¬: ${{ matrix.version }}\nç›®æ ‡è®¾å¤‡: ${{ matrix.target }}\næ„å»ºæ—¶é—´: $(date)\n\næ–‡ä»¶MD5æ ¡éªŒå’Œ:\n" > "$INFO_FILE"
          for file in *; do
            if [ -f "$file" ] && [ "$file" != "$INFO_FILE" ]; then
              md5=$(md5sum "$file" | awk '{print $1}')
              echo "$md5  $file" >> "$INFO_FILE"
            fi
          done
          
          cp /workdir/openwrt/.config  ./${{ matrix.version }}_${{matrix.target}}.config 2>/dev/null || true
          
          echo "FIRMWARE=$PWD" >> $GITHUB_ENV
          echo "status=success" >> $GITHUB_OUTPUT

      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        if: steps.organize.outputs.status == 'success' && !cancelled()
        with:
          name: firmware-${{ matrix.version }}_${{ matrix.target }}_${{ env.FILE_DATE }}
          path: ${{ env.FIRMWARE }}

      - name: ä¿å­˜ç‰ˆæœ¬å’Œç›®æ ‡ä¿¡æ¯
        working-directory: /workdir
        if: steps.organize.outputs.status == 'success'
        run: |
          echo "${{ matrix.version }}:${{ env.DEVICE_NAME }}" >> version_target_${{ matrix.version }}_${{ matrix.target }}.txt

      - name: ä¸Šä¼ ç‰ˆæœ¬ä¿¡æ¯
        uses: actions/upload-artifact@v4
        with:
          name: version_info_${{ matrix.version }}_${{ matrix.target }}
          path: /workdir/version_target_${{ matrix.version }}_${{ matrix.target }}.txt

      - name: è®¾ç½®ä½œä¸šè¾“å‡º
        id: set-outputs
        run: |
          echo "upload_release=${{ env.UPLOAD_RELEASE }}" >> $GITHUB_OUTPUT

  release-all:
    name: åˆå¹¶å‘å¸ƒæ‰€æœ‰å›ºä»¶
    runs-on: ubuntu-latest
    needs: build
    if: |
      ${{ 
        always() && 
        !cancelled() && 
        contains(join(needs.build.*.result, ','), 'success')  && 
        needs.build.outputs.upload_release == 'true' 
      }}

    steps:
      - name: å‡†å¤‡ç›®å½•ï¼ˆç¡®ä¿ç›®å½•å­˜åœ¨ï¼‰
        run: |
          mkdir -p all-firmwares
          mkdir -p version-info-all

      - name: ä¸‹è½½æ‰€æœ‰å›ºä»¶äº§ç‰©ï¼ˆç²¾å‡†åŒ¹é…ï¼‰
        uses: actions/download-artifact@v4
        with:
          path: all-firmwares
          pattern: firmware-*
          merge-multiple: false

      - name: ä¸‹è½½ç‰ˆæœ¬ä¿¡æ¯
        uses: actions/download-artifact@v4
        with:
          path: version-info-all
          pattern: version_info_*
          merge-multiple: false

      - name: æ£€æŸ¥æ˜¯å¦å­˜åœ¨æœ‰æ•ˆå›ºä»¶æ–‡ä»¶
        run: |
          # æœç´¢æ‰€æœ‰å­ç›®å½•ä¸­çš„.bin/.imgæ–‡ä»¶ï¼ˆé€‚é…åµŒå¥—ç›®å½•ç»“æ„ï¼‰
          FIRMWARE_FILES=$(find all-firmwares -type f \( -name "*.bin" -o -name "*.img" \))
          if [ -z "$FIRMWARE_FILES" ]; then
            echo "é”™è¯¯ï¼šæœªæ‰¾åˆ°ä»»ä½•å›ºä»¶æ–‡ä»¶ï¼ˆ.bin/.imgï¼‰ï¼Œè¯·æ£€æŸ¥buildä½œä¸šæ˜¯å¦æ­£ç¡®ç”Ÿæˆäº§ç‰©"
            # æ‰“å°ç›®å½•ç»“æ„è¾…åŠ©è°ƒè¯•
            echo "å½“å‰all-firmwaresç›®å½•ç»“æ„ï¼š"
            tree all-firmwares
            exit 1
          else
            echo "æ‰¾åˆ°ä»¥ä¸‹å›ºä»¶æ–‡ä»¶ï¼š"
            echo "$FIRMWARE_FILES"
          fi

      - name: æå–ç‰ˆæœ¬å’Œç›®æ ‡ä¿¡æ¯
        id: extract_version_target
        run: |
          echo "æ‰€æœ‰ç‰ˆæœ¬å’Œç›®æ ‡è®¾å¤‡ä¿¡æ¯æ±‡æ€»" > version-info-all.txt
          echo "==========================================" >> version-info-all.txt
          
          VERSIONS=()
          TARGETS=()
          
          # éå†ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ï¼ˆé€‚é…åµŒå¥—ç›®å½•ï¼‰
          for file in $(find version-info-all -type f -name "version_target_*.txt"); do
            if [ -f "$file" ]; then
              cat "$file" >> version-info-all.txt
              echo "==========================================" >> version-info-all.txt
              while IFS= read -r line; do
                IFS=':' read -ra parts <<< "$line"
                VERSIONS+=("${parts[0]}")
                TARGETS+=("${parts[1]}")
              done < "$file"
            fi
          done
          
          UNIQUE_VERSIONS=($(printf "%s\n" "${VERSIONS[@]}" | sort -u))
          UNIQUE_TARGETS=($(printf "%s\n" "${TARGETS[@]}" | sort -u))
          echo "versions=${UNIQUE_VERSIONS[*]}" >> $GITHUB_OUTPUT
          echo "targets=${UNIQUE_TARGETS[*]}" >> $GITHUB_OUTPUT

      - name: æ•´ç†åˆå¹¶å›ºä»¶
        run: |
          mkdir -p final-release
          # å¤åˆ¶æ‰€æœ‰å›ºä»¶æ–‡ä»¶ã€é…ç½®æ–‡ä»¶å’Œä¿¡æ¯æ–‡ä»¶ï¼ˆæ’é™¤åµŒå¥—ç›®å½•ç»“æ„ï¼‰
          find all-firmwares -type f \( -name "*.bin" -o -name "*.img" -o -name "*.config" -o -name "*build-info.txt" \) -exec cp {} final-release/ \;
          
          # åˆå¹¶æ‰€æœ‰æ„å»ºä¿¡æ¯
          echo "# æ‰€æœ‰å›ºä»¶è¯¦ç»†ä¿¡æ¯" > final-release/all-build-info.txt
          echo "==========================================" >> final-release/all-build-info.txt
          for info_file in $(find final-release -type f -name "*build-info.txt" | grep -v "all-build-info.txt"); do
            if [ -f "$info_file" ]; then
              echo -e "\n$(cat "$info_file")" >> final-release/all-build-info.txt
              echo "==========================================" >> final-release/all-build-info.txt
              rm -f "$info_file"  # åˆ é™¤å•ä¸ªä¿¡æ¯æ–‡ä»¶
            fi
          done
          
          # ç”Ÿæˆå‘å¸ƒè¯´æ˜
          echo "# OpenWRT å›ºä»¶æ±‡æ€»å‘å¸ƒ" > release.txt
          echo "å‘å¸ƒæ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" >> release.txt
          echo "åŒ…å«ä»¥ä¸‹ç‰ˆæœ¬å’Œè®¾å¤‡çš„å›ºä»¶ï¼š" >> release.txt
          echo "- ç‰ˆæœ¬: ${{ steps.extract_version_target.outputs.versions }}" >> release.txt
          echo "- è®¾å¤‡: ${{ steps.extract_version_target.outputs.targets }}" >> release.txt
          echo -e "\nå„å›ºä»¶è¯¦ç»†ä¿¡æ¯åŠMD5è¯·æŸ¥çœ‹ all-build-info.txt æ–‡ä»¶" >> release.txt
          echo -e "\nğŸŒ é»˜è®¤ç®¡ç†IP: 192.168.123.1" >> release.txt

      - name: ç”Ÿæˆç»Ÿä¸€å‘å¸ƒæ ‡ç­¾
        id: tag
        run: |
          echo "release_tag=openwrt-all-firmwares_$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

      - name: å‘å¸ƒåˆå¹¶åçš„Release
        uses: softprops/action-gh-release@master
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.tag.outputs.release_tag }}
          body_path: release.txt
          files: final-release/*

      - name: ä¿ç•™æœ€æ–°3ä¸ªRelease
        uses: dev-drprasad/delete-older-releases@v0.3.3
        with:
          keep_latest: 3
          delete_tags: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: åˆ é™¤æ—§çš„å·¥ä½œæµç¨‹
        uses: Mattraks/delete-workflow-runs@main
        with:
          retain_days: 0
          keep_minimum_runs: 3
